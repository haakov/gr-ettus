# auto-generated by grc.converter

id: uhd_rfnoc_streamer_ddc
label: 'RFNoC: DDC'

parameters:
-   id: num_chans
    label: Num Channels
    dtype: int
    default: '1'
    options: ['1', '2']
    hide: part
-   id: input_rate
    label: Input Rate
    dtype: real
    default: samp_rate
-   id: output_rate
    label: Output Rate
    dtype: real
    default: decim_rate
-   id: freq
    label: Frequency (CORDIC)
    dtype: real
    default: '0.0'
-   id: fullscale
    label: Full scale
    category: Advanced
    dtype: real
    default: '1.0'
    hide: part
-   id: block_index
    label: Block Select
    category: RFNoC Config
    dtype: int
    default: '-1'
    hide: ${ ('part' if int(block_index) < 0 else 'none') }
-   id: device_index
    label: Device Select
    category: RFNoC Config
    dtype: int
    default: '-1'
    hide: ${ ('part' if int(device_index) < 0 else 'none') }
-   id: fpga_module_name
    label: FPGA Module Name
    category: RFNoC Config
    dtype: string
    default: noc_block_ddc
    hide: all
-   id: grvlen
    label: Force Vector Length
    dtype: int
    default: '1'
    hide: ${ 'part' if vlen == 1 else 'none' }

inputs:
-   domain: stream
    dtype: complex
    vlen: ${ grvlen }
    multiplicity: ${ num_chans }

outputs:
-   domain: stream
    dtype: complex
    vlen: ${ grvlen }
    multiplicity: ${ num_chans }
asserts:
- ${ output_rate <= input_rate }
- ${ output_rate >= input_rate/1024 }

templates:
    imports: import ettus
    make: |
        ettus.rfnoc_generic(
            self.device3,
            uhd.stream_args( \# TX Stream Args
                cpu_format="fc32", \# TODO: This must be made an option
                otw_format="sc16",
                channels=range(${num_chans}),
                args="input_rate={},output_rate={},fullscale={},freq={},gr_vlen={},{}".format(${input_rate}, ${output_rate}, ${fullscale}, ${freq}, ${grvlen}, "" if ${grvlen} == 1 else "spp={}".format(${grvlen})),
            ),
            uhd.stream_args( \# RX Stream Args
                cpu_format="fc32", \# TODO: This must be made an option
                otw_format="sc16",
                channels=range(${num_chans}),
                args="gr_vlen={},{}".format(${grvlen}, "" if ${grvlen} == 1 else "spp={}".format(${grvlen})),
            ),
            "DDC", ${block_index}, ${device_index},
        )
        for chan in xrange(${num_chans}):
            self.${id}.set_arg("input_rate", float(${input_rate}), chan)
            self.${id}.set_arg("output_rate", float(${output_rate}), chan)
            self.${id}.set_arg("fullscale", ${fullscale}, chan)
            self.${id}.set_arg("freq", ${freq}, chan)
    callbacks:
    - "for i in xrange(${num_chans}):\n    self.${id}.set_arg(\"freq\", ${freq}, i)"
    - "for i in xrange(${num_chans}):\n    self.${id}.set_arg(\"input_rate\", float(${input_rate}),\
        \ i)"
    - "for i in xrange(${num_chans}):\n    self.${id}.set_arg(\"output_rate\", float(${output_rate}),\
        \ i)"

file_format: 1
